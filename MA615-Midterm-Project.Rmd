---
title: "Tidying of Job Patterns Data - MA615 Midterm Project"
author: "Munan Hou"
date: "October 16, 2016"
output: html_document
---
#Information of the dataset
Topic: "Job Patterns For Minorities And Women In Private Industry, 2009 EEO-1 NAICS-4 Aggregate Report"
File name: YEAR09_CBSA_NAC3.txt (with data_dictionary NAICS.xls)
Resource from: 
https://catalog.data.gov/dataset/job-patterns-for-minorities-and-women-in-private-industry-2009-eeo-1-naics-4-aggregate-rep

#Import Data
First of all we import the data from the .txt file, using read.table here. It is noticed that the separation of this dataset is ";" instead of ",", so we added the "sep";" argument. There is no missing values inside the dataset, or the missing values are valued instead of leaving blank.

```{r import txt}
library(plyr)
library(dplyr)
library(tidyr)
library(ggplot2)
data <- read.table("data/YEAR09_CBSA_NAC3.txt", header = TRUE, sep = ";", quote = "", dec = ".", fill = TRUE)
data_backup <- data
```

This dataframe contains 600 columns(variables), 9064 rows(observations).

#Analysis of the dataset

In my understianding, because the dataset are named with "minorities and women", this dataset should be generally used to analyse:

- the probable different job patterns among races, under each industry, or under each job category.
- the probable different job patterns between genders, under each industry, or under each job category.
- the probable different job patterns under the two kinds of previous precondition, and further under different geographic positions.

```{r}
head(data, n=1)
```

By looking at the data dictionary NAICS.xls, and also by reading the dataset, we can have the information below:

Three categories under gender: Male, Female and Total

The industries are separated into 11 different categories within each race and gender, labeled as *1, *2, ... *10, *1_2 (* represents the wildcard character). Same number represent the same categoreis although in different industries.

As long as our purpose of tidying this data is known, the tidying steps are as follow. After data being tidied up, the data should become more clear to model, compare and test for difference's significance.

#First step, analyse the 600 columns

The first obvious mess thing is that, it is sure not each of columns should be a single variable. Inside columns, there are both variables and observations. Within them, "CBSA_LABEL" are area information, "NAC3_Label" are industry information; they are for sure fixed variables(dimensions) of the data. For variables "X_TYPE_", "TOTAL_UNIT", "FIRMS", "pctofst", I can't figure out what do they mean; however,

For "X_TYPE_"

```{r}
count(data, X_TYPE_)
```

there is only one kind of outcome. So I think it could be the input type of the observation such as "integer", etc., os it is proper to treat it as a fixed variable and leave it unchanged. 

```{r}
unknown <- data.frame(data$CBSA_LABEL, data$NAC3_Label, data$TOTAL_UNIT, data$FIRMS, data$pctofst)
```

For "TOTAL_UNIT", 

```{r}
count(data, TOTAL_UNIT)
min(data$TOTAL_UNIT)
max(data$TOTAL_UNIT)
```

For "FIRMS"
"
```{r}
count(data, FIRMS)
min(data$FIRMS)
max(data$FIRMS)
```

For "pctofst", could be "percent of state"

```{r}
min(data$pctofst)
max(data$pctofst)
sum(data$pctofst)
```

No conclusion found. Leave unchanged. While as long as it seems could be a proper variable(although not fixed), I'll leave and regard it as already tidied.

Then for the rest of the listed variables. Three different variables should be extracted: 

- RACE("TOTAL", "WH(White)", "BLK(Black)", "HISP(Hispanic)", "ASIAN", "AIAN(Indian)", "nhopi(Hawaiian)", "tomr(Two Race)", "Min(Minority)", "WHp(%)", "BLKp(%)", "HISPp(%)", "AIANp(%)", "nhopip(%)", "asianp(%)", "tomrp(%)", "Minp(%)", "PTOTAL(%)"), 
- GENDER("F", "M", "T = F + M"), 
- INDUSTRY("*1, *2, ... *10, *1_2"s)

In my first thought, there should be actually these fixed and measured variable column:

- CBSA_LABEL
- NAC3_Label
- X_TYPE_

- FIRMS
- pctofst

- TOTAL_UNIT
- INDUSTRY
- GENDER
- RACE

- count

So I'll try to start tidy now.

```{r}
data$label <- c(1:nrow(data)) #mark for further merge
data <- data[,c(601,1:600)] #rearrange the label vector to the first
```

```{r}
VAR_NAME_ALL <- c(variable.names(data))
VAR_NAME_ALL
VAR_NAME <- VAR_NAME_ALL[seq(6,589,11)]
VAR_NAME #will be used later, in order to rename the merged races and genders' variables
```

```{r}
data <- data_backup #Always have everyting backuped
```

#Trying to tidy all variables up

First notice the sequence of each "total", "male" and "female" are not fixed. For further convenience when looping, we make up the columns first, letting them in a tidy order of "T", "M", "F".

```{r}
name_list <- data.frame(number=c(1:(11*18*3)), variable.names(data)[6:599])
```

Then read manully and rearrange.
```{r}
test <- data[,c(1:275, 287:297, 276:286,
                
                474,476:484,475, #WHtp
                298,300:308,299, #WHMp
                386,388:396,387, #WHfp
                
                (474+11*1),(476+11*1):(484+11*1),(475+11*1), #BLKtp
                (298+11*1),(300+11*1):(308+11*1),(299+11*1), #BLKMp
                (386+11*1),(388+11*1):(396+11*1),(387+11*1), #BLKfp
                
                (474+11*2),(476+11*2):(484+11*2),(475+11*2), #HISPtp
                (298+11*2),(300+11*2):(308+11*2),(299+11*2), #HISPMp
                (386+11*2),(388+11*2):(396+11*2),(387+11*2), #HISPfp
                
                (474+11*3),(476+11*3):(484+11*3),(475+11*3), #AIANtp1
                (298+11*3),(300+11*3):(308+11*3),(299+11*3), #AIANMp1
                (386+11*3),(388+11*3):(396+11*3),(387+11*3), #AIANfp1
                
                (474+11*4),(476+11*4):(484+11*4),(475+11*4), #nhopitp
                (298+11*4),(300+11*4):(308+11*4),(299+11*4), #nhopiMp
                (386+11*4),(388+11*4):(396+11*4),(387+11*4), #nhopifp
                
                (474+11*5),(476+11*5):(484+11*5),(475+11*5), #asiantp
                (298+11*5),(300+11*5):(308+11*5),(299+11*5), #asianMp
                (386+11*5),(388+11*5):(396+11*5),(387+11*5), #asianfp
                
                (474+11*6),(476+11*6):(484+11*6),(475+11*6), #tomrtp
                (298+11*6),(300+11*6):(308+11*6),(299+11*6), #tomrMp
                (386+11*6),(388+11*6):(396+11*6),(387+11*6), #tomrfp
                
                (474+11*7),(476+11*7):(484+11*7),(475+11*7), #MinTp
                (298+11*7),(300+11*7):(308+11*7),(299+11*7), #MinMp
                (386+11*7),(388+11*7):(396+11*7),(387+11*7), #MinFp
                
                584,586:594,585, #PTOTAL
                562,564:572,563, #MTp
                573,575:583,574  #FTp
                
                )]
```

```{r first step tidying everything}
data_TOTAL_T <- data[c(1, 6:16)]
data_TOTAL_M <- data[c(1, 17:27)]
data_TOTAL_F <- data[c(1, 28:38)]

INDUSTRY_NAME <- c("label", 1:11) #I first rename the column names, then merge them
names(data_TOTAL_T) <- INDUSTRY_NAME
names(data_TOTAL_M) <- INDUSTRY_NAME
names(data_TOTAL_F) <- INDUSTRY_NAME

data_TOTAL_T$GENDER <- "T"
data_TOTAL_M$GENDER <- "M"
data_TOTAL_F$GENDER <- "F"
data_TOTAL_T$RACE <- "TOTAL"
data_TOTAL_F$RACE <- "TOTAL"
data_TOTAL_M$RACE <- "TOTAL"

data_TOTAL_T <- gather(data_TOTAL_T, INDUSTRY, count, 2:12)
data_TOTAL_F <- gather(data_TOTAL_F, INDUSTRY, count, 2:12)
data_TOTAL_M <- gather(data_TOTAL_M, INDUSTRY, count, 2:12)

data_TOTAL <- bind_rows(data_TOTAL_T, data_TOTAL_F, data_TOTAL_M)
```

```{r}

```

But this could be too long. My computer won't handle this tidy format.

Also, it  can be unnecessary to tidy industries because we don't need to test the difference among different industry

#For compare different races & genders in same industries, we only tidy the part of industries:



```{r forgot merge by multiple columns}
data_sort_in_T <- data[c(1, 6:16)]
data_sort_in_M <- data[c(1, 17:27)]
data_sort_in_F <- data[c(1, 28:38)]

INDUSTRY_NAME <- c("label", 1:11)
names(data_sort_in_T) <- names(data_sort_in_M) <- names(data_sort_in_F) <- INDUSTRY_NAME


data_sort_in_T <- gather(data_sort_in_T, INDUSTRY, count_Tt, 2:12)
data_sort_in_M <- gather(data_sort_in_M, INDUSTRY, count_Tm, 2:12)
data_sort_in_F <- gather(data_sort_in_F, INDUSTRY, count_Tf, 2:12)

data_sort_in_T$label_2 <- c(1:nrow(data_sort_in_T))
data_sort_in_M$label_2 <- c(1:nrow(data_sort_in_M)) 
data_sort_in_F$label_2 <- c(1:nrow(data_sort_in_F))  

data_sort_in_T <- data_sort_in_T[,-1]
data_sort_in_M <- data_sort_in_M[,-(1:2)]
data_sort_in_F <- data_sort_in_F[,-(1:2)]

data_sort_in <- left_join(data_sort_in_T, data_sort_in_F, by="label_2")
data_sort_in <- left_join(data_sort_in, data_sort_in_M, by="label_2")
```

```{r fixed one step}
data_sort_in_T <- data[c(1, 6:16)]
data_sort_in_M <- data[c(1, 17:27)]
data_sort_in_F <- data[c(1, 28:38)]

INDUSTRY_NAME <- c("label", 1:11)
as.numeric(INDUSTRY_NAME)
names(data_sort_in_T) <- names(data_sort_in_M) <- names(data_sort_in_F) <- INDUSTRY_NAME


data_sort_in_T <- gather(data_sort_in_T, INDUSTRY, count_Tt, 2:12)
data_sort_in_M <- gather(data_sort_in_M, INDUSTRY, count_Tm, 2:12)
data_sort_in_F <- gather(data_sort_in_F, INDUSTRY, count_Tf, 2:12)



data_sort_in <- merge(data_sort_in_T, data_sort_in_M, by=c("label", "INDUSTRY"))
data_sort_in <- merge(data_sort_in, data_sort_in_F, by=c("label", "INDUSTRY"))
```

```{r first step before loop}
INDUSTRY_NAME <- c("label", 1:11)
data_sort_in <- data.frame(label = NA, INDUSTRY = NA)

data_sort_in_1 <- data[c(1, (6):(16))]
data_sort_in_2 <- data[c(1, (17):(27))]
data_sort_in_3 <- data[c(1, (28):(38))]

names(data_sort_in_1) <- names(data_sort_in_2) <- names(data_sort_in_3) <- INDUSTRY_NAME

data_sort_in_1 <- gather(data_sort_in_1, INDUSTRY, a, 2:12)
data_sort_in_2 <- gather(data_sort_in_2, INDUSTRY, b, 2:12)
data_sort_in_3 <- gather(data_sort_in_3, INDUSTRY, c, 2:12)

names(data_sort_in_1) <- c("label", "INDUSTRY", VAR_NAME[1])
names(data_sort_in_2) <- c("label", "INDUSTRY", VAR_NAME[2])
names(data_sort_in_3) <- c("label", "INDUSTRY", VAR_NAME[3])

data_sort_in <- merge(data_sort_in_1, data_sort_in_2, by=c("label", "INDUSTRY"))
data_sort_in <- merge(data_sort_in, data_sort_in_3, by=c("label", "INDUSTRY"))
```
rm(data_sort_in_3)
```{r second step loop}


for (i in 1:(11*18*3-1)) {

data_sort_in_1 <- data[c(1, (33*i + 6):(33*i + 16))]
data_sort_in_2 <- data[c(1, (33*i + 17):(33*i + 27))]
data_sort_in_3 <- data[c(1, (33*i + 28):(33*i + 38))]

names(data_sort_in_1) <- names(data_sort_in_2) <- names(data_sort_in_3) <- INDUSTRY_NAME

data_sort_in_1 <- gather(data_sort_in_1, INDUSTRY, a, 2:12)
data_sort_in_2 <- gather(data_sort_in_2, INDUSTRY, b, 2:12)
data_sort_in_3 <- gather(data_sort_in_3, INDUSTRY, c, 2:12)

names(data_sort_in_1) <- c("label", "INDUSTRY", VAR_NAME[3*i + 1])
names(data_sort_in_2) <- c("label", "INDUSTRY", VAR_NAME[3*i + 2])
names(data_sort_in_3) <- c("label", "INDUSTRY", VAR_NAME[3*i + 3])

data_sort_in <- merge(data_sort_in, data_sort_in_1, by=c("label", "INDUSTRY"))
data_sort_in <- merge(data_sort_in, data_sort_in_2, by=c("label", "INDUSTRY"))
data_sort_in <- merge(data_sort_in, data_sort_in_3, by=c("label", "INDUSTRY"))

}
```

```{r make dictionary}
data_dict <- data[c(1:5,(ncol(data)-1),ncol(data))]
head(data_dict)
```

```{r merge}
data_sort_in_final <- right_join(data_dict, data_sort_in, by="label")
```

```{r rename INDUSTRY}
data_sort_in_final <- data_sort_in_final
data_sort_in_final$INDUSTRY[which(data_sort_in_final$INDUSTRY == "1")] = "SENIOR OFF AND MGRS"
data_sort_in_final$INDUSTRY[which(data_sort_in_final$INDUSTRY == "2")] = "PROFESSIONALS"
data_sort_in_final$INDUSTRY[which(data_sort_in_final$INDUSTRY == "3")] = "TECHNICIANS"
data_sort_in_final$INDUSTRY[which(data_sort_in_final$INDUSTRY == "4")] = "SALES WORKERS"
data_sort_in_final$INDUSTRY[which(data_sort_in_final$INDUSTRY == "5")] = "OFFICE AND CLERICALS"
data_sort_in_final$INDUSTRY[which(data_sort_in_final$INDUSTRY == "6")] = "CRAFT WORKERS"
data_sort_in_final$INDUSTRY[which(data_sort_in_final$INDUSTRY == "7")] = "OPERATIVES"
data_sort_in_final$INDUSTRY[which(data_sort_in_final$INDUSTRY == "8")] = "LABORERS"
data_sort_in_final$INDUSTRY[which(data_sort_in_final$INDUSTRY == "9")] = "SERVICE WORKERS"
data_sort_in_final$INDUSTRY[which(data_sort_in_final$INDUSTRY == "10")] = "TOTAL"
data_sort_in_final$INDUSTRY[which(data_sort_in_final$INDUSTRY == "11")] = "MID OFF AND MGRS"
```

```{r re-list variables, remove label}
data_sort_in_final <- data_sort_in_final[,c(2:5),c(8:ncol(data_sort_in_final),c(6:7))]
```

So this is the final tidy dataset in this situation.








#Drafts

```{r}
data_TOTAL <- gather(data_TOTAL, INDUSTRY_T, INDUSTRY_count, 5:15)
data_TOTAL <- gather(data_TOTAL, INDUSTRY_M, INDUSTRY_count, 5:15)
data_TOTAL <- gather(data_TOTAL, INDUSTRY_F, INDUSTRY_count, 5:15)
head(data_TOTAL)
```

```{r gather WH}
data2 <- gather(data, INDUSTRY_TOTAL, INDUSTRY_count, 5:15)
head(data2[,c(1:4,590,591)])
```

rm(data_TOTAL_gathered)

```{r}
data_WH
data_BLK
data_HISP
data_ASIAN
data_AIAN
data_nhopi
data_tomr
data_Min
data_WHp
data_BLKp
data_HISPp
data_AIANp
data_nhopip
data_asianp
data_tomrp
data_Minp
data_PTOTAL
```


```{r}
data2 <- data
gather(data2, INDUSTRY, )
```

stocks <- data_frame(
  time = as.Date('2009-01-01') + 0:9,
  X = rnorm(10, 0, 1),
  Y = rnorm(10, 0, 2),
  Z = rnorm(10, 0, 4)
)

stocks3 <- gather(stocks, stock, price, 2:4)
stocksb <- data.frame(stocks,
  A = rnorm(10, 0, 8),
  B = rnorm(10, 0, 16),
  C = rnorm(10, 0, 32)
)

```{r}

```

bind_rows()

4+11*18*3
ncol(data)



```{r}
seqtemp <- seq(1,length(data),1)
v <- c()
for (i in seqtemp){
  v[i] <- c(is.null(data[i]))
}
print(v)
```

v <- c(data$NAC3_Label)
vFIRMS <- c(data$FIRMS)
head(vFIRMS, n = 100)
unique(data$FIRMS)

head(data$WHMp1)
head(data$WHfp1)
sump <- data$WHMp1 + data$WHfp1
head(sump)

rm(data)
data2 <- data



?read.table
rm("data")


count(unique(data$NAC3_Label))
count(data, NAC3_Label)
count(data, CBSA_LABEL)
vcount <- count(data, TOTAL_UNIT)

head(vcount)
hist(vcount)


count()

TOTAL_UNIT <- data$TOTAL_UNIT
ggplot(data, aes(x = TOTAL_UNIT, y = count(data$TOTAL_UNIT))) + geom_histogram(binwidth = 5)




data[!complete.cases(data),]

tbl = tabular 扁平的




cc <- count(data, pctofst)


#Split

Split by RACE, GENDER, 

```{r}
data_TOTAL <- data[c(5:15)]
data_TOTAL_gathered <- gather(data_TOTAL, INDUSTRY, count, 1:11)
data_TOTAL_gathered <- mutate(data_TOTAL_gathered, RACE = "T", GENDER = "T")
#stocks3 <- gather(stocks, stock, price, 2:4)
```

























